<!DOCTYPE html> <html lang="th"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <title>TIANTIAN COMPUTER - PC Builder</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet"> <style> body { font-family: 'Kanit', sans-serif; background: #020617; color: #f8fafc; scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; } .font-gaming { font-family: 'Orbitron', sans-serif; } .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); } .neon-border { border: 1px solid #22d3ee; box-shadow: 0 0 15px rgba(34, 211, 238, 0.3); } .tab-active { color: #22d3ee; border-bottom: 3px solid #22d3ee; } .animate-fade-in { animation: fadeIn 0.3s ease forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } } #category-container::-webkit-scrollbar { display: none; } .delete-btn { position: absolute; top: 10px; right: 10px; } </style> <!-- Supabase CDN (replace with your project's URL and anon key in the script below) --> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script> <!-- html2canvas CDN for saving summary as image --> <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> </head> <body class="min-h-screen pb-10">
  <nav class="glass sticky top-0 z-50 px-4 md:px-8 py-4 flex justify-between items-center mb-6">
    <div class="text-lg md:text-2xl font-gaming font-bold text-cyan-400 tracking-widest uppercase cursor-pointer" onclick="location.reload()">TIANTIAN COMPUTER</div>
    <div class="flex gap-3 md:gap-6 items-center">
        <button onclick="switchTab('catalog')" id="tab-catalog" class="tab-active py-1 text-[10px] md:text-sm font-gaming uppercase transition">Catalog</button>
        <button onclick="switchTab('builder')" id="tab-builder" class="py-1 text-[10px] md:text-sm font-gaming uppercase text-gray-400 transition hover:text-cyan-400">Builder</button>
        <button onclick="openAdminModal()" class="px-3 py-1.5 bg-cyan-600/20 text-cyan-400 rounded-lg border border-cyan-500/50 hover:bg-cyan-600 hover:text-white transition text-[9px] md:text-[10px] font-bold">
            + ADD PRODUCT
        </button>
    </div>
</nav>

<div class="max-w-7xl mx-auto px-4 md:px-6">
    <section id="section-catalog" class="block">
        <div class="flex flex-col mb-6 gap-4">
            <h2 class="text-2xl md:text-3xl font-bold font-gaming uppercase italic text-cyan-400 tracking-tighter">Inventory</h2>
            <div id="category-container" class="flex gap-2 overflow-x-auto pb-2 w-full whitespace-nowrap scroll-smooth"></div>
        </div>
        <div class="flex gap-3 mb-4 flex-wrap items-center">
            <input type="text" id="catalog-search" placeholder="Search products..." class="flex-1 min-w-[200px] bg-slate-800 border border-gray-700 p-2 rounded-lg text-white text-sm outline-none focus:border-cyan-400 transition" oninput="applySearchAndSort()">
            <select id="catalog-sort" onchange="applySearchAndSort()" class="bg-slate-800 border border-gray-700 p-2 rounded-lg text-white text-sm outline-none focus:border-cyan-400">
                <option value="">Sort by</option>
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
            </select>
        </div>
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-20"></div>
    </section>

    <section id="section-builder" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-20">
            <div class="lg:col-span-2 space-y-3">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl md:text-3xl font-bold font-gaming uppercase italic text-cyan-400">Custom Build</h2>
                    <div class="flex items-center gap-3">
                        <button id="reset-build" onclick="resetBuild()" class="border border-red-500 text-red-400 hover:bg-red-600/10 px-3 py-2 rounded-xl text-[10px] font-bold uppercase" style="box-shadow:0 0 8px rgba(239,68,68,0.08)">RESET BUILD</button>
                    </div>
                </div>
                <div id="builder-slots" class="space-y-3"></div>
            </div>
            <div class="lg:col-span-1">
                <div id="summary-box" class="glass p-5 rounded-2xl sticky top-24 neon-border">
                    <h3 class="text-lg font-bold mb-4 font-gaming text-cyan-400 text-center uppercase tracking-widest">Summary</h3>
                    <div id="summary-items" class="space-y-2 mb-6 text-xs md:text-sm text-gray-300"></div>
                    <div class="border-t border-gray-700 pt-4 flex flex-col items-end gap-1">
                        <span class="text-[10px] text-gray-400 font-gaming uppercase">Total Amount</span>
                        <div class="flex items-baseline gap-2">
                            <span id="total-price-display" class="text-2xl md:text-3xl font-bold text-green-400 font-gaming">0</span>
                            <span class="text-green-400 font-bold font-gaming text-sm">₭</span>
                        </div>
                    </div>
                    <button onclick="saveImage()" class="w-full mt-6 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl transition uppercase text-[10px] font-gaming">SAVE IMAGE</button>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Admin Modal -->
<div id="admin-modal" class="fixed inset-0 bg-black/95 hidden z-[110] flex items-center justify-center p-2 md:p-4">
    <div class="glass w-full max-w-lg rounded-2xl p-6 md:p-8 neon-border shadow-2xl overflow-y-auto max-h-[95vh]">
        <h3 id="admin-title" class="text-xl font-bold text-cyan-400 mb-6 font-gaming uppercase tracking-wider text-center">Manage Product</h3>
        <form id="product-form" class="space-y-4">
            <input type="hidden" id="p-id">
            <div>
                <label class="block text-[10px] text-gray-400 mb-1 uppercase font-bold">Product Name</label>
                <input type="text" id="p-name" class="w-full bg-slate-800 border border-gray-700 p-3 rounded-lg text-white focus:border-cyan-400 outline-none text-sm transition" required>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] text-gray-400 mb-1 uppercase font-bold">Category</label>
                    <select id="p-category" onchange="renderDynamicSpecs()" class="w-full bg-slate-800 border border-gray-700 p-3 rounded-lg text-white text-sm outline-none focus:border-cyan-400">
                        <option value="CPU">CPU</option>
                        <option value="Motherboard">Motherboard</option>
                        <option value="GPU">GPU</option>
                        <option value="RAM">RAM</option>
                        <option value="PSU">PSU</option>
                        <option value="Case">Case</option>
                        <option value="Storage">Storage</option>
                        <option value="CPU Cooler">CPU Cooler</option>
                        <option value="Case Fan">Case Fan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-400 mb-1 uppercase font-bold">Price (₭)</label>
                    <input type="number" id="p-price" class="w-full bg-slate-800 border border-gray-700 p-3 rounded-lg text-white text-sm focus:border-cyan-400 outline-none" required>
                </div>
            </div>
            <div id="dynamic-specs-container" class="space-y-4 pt-2"></div>
            <div>
                <label class="block text-[10px] text-gray-400 mb-1 uppercase font-bold">Image File</label>
                <input type="file" id="p-image-file" accept="image/*" class="w-full text-[10px] text-gray-400 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-cyan-600 file:text-white cursor-pointer hover:file:bg-cyan-500">
                <div id="image-preview" class="mt-3 text-center">
                    <img id="preview-img" src="" class="max-h-40 mx-auto rounded-lg hidden">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeAdminModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold uppercase text-[10px] transition">Cancel</button>
                <button type="submit" id="btn-save" class="flex-1 bg-cyan-600 hover:bg-cyan-500 py-3 rounded-xl font-bold uppercase text-[10px] transition">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Product Picker Modal -->
<div id="modal" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-end md:items-center justify-center p-0 md:p-4">
    <div class="glass w-full max-w-4xl h-[90vh] md:h-auto md:max-h-[85vh] overflow-hidden rounded-t-3xl md:rounded-3xl flex flex-col border border-cyan-500/30">
        <div class="p-5 border-b border-gray-700 flex justify-between items-center">
            <h3 id="modal-title" class="text-lg font-bold text-cyan-400 font-gaming uppercase tracking-widest">Select Part</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl transition">&times;</button>
        </div>
        <div id="modal-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 p-4 overflow-y-auto"></div>
    </div>
</div>

<script>
let allProducts = [];
let selectedParts = {};
const categories = ["CPU", "Motherboard", "GPU", "RAM", "PSU", "Case", "Storage", "CPU Cooler", "Case Fan"];
const STORAGE_KEY = "pc_master_products";
const BUILDER_KEY = "pc_master_builder";

// ---------- Supabase config (REPLACE these with your project's values) ----------
const SUPABASE_URL = "https://mscglrrjkvfzumfudmmh.supabase.co"; // replace
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zY2dscnJqa3ZmenVtZnVkbW1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NDE0MzcsImV4cCI6MjA4NjUxNzQzN30.Cy_ZJKEsbErW_97y-ddFTas_ZNe-OH3vzE7QvuRH__A"; // replace
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let productsSubscription = null;


// ============ LocalStorage Functions ============
function saveProducts() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(allProducts));
}

function loadProducts() {
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
}

function saveBuilder() {
    localStorage.setItem(BUILDER_KEY, JSON.stringify(selectedParts));
}

function loadBuilder() {
    const stored = localStorage.getItem(BUILDER_KEY);
    return stored ? JSON.parse(stored) : {};
}

function generateId() {
    return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// ============ Initialize ============
async function fetchProductsFromSupabase() {
    try {
        const { data, error } = await supabaseClient
            .from('products')
            .select('*')
            .order('created_at', { ascending: false });
        if (error) throw error;
        allProducts = data || [];
        renderCategoryButtons();
        filterCatalog('All');

        // Setup realtime subscription once
        if (!productsSubscription) {
            try {
                productsSubscription = supabaseClient
                    .channel('public:products')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, payload => {
                        // Re-fetch on any change
                        fetchProductsFromSupabase();
                    })
                    .subscribe();
            } catch (subErr) {
                // Fallback: ignore subscription errors
                console.warn('Realtime subscription failed', subErr);
            }
        }
    } catch (err) {
        console.error('Failed to fetch products from Supabase:', err.message || err);
        // fallback to localStorage if available
        allProducts = loadProducts();
        renderCategoryButtons();
        filterCatalog('All');
    }
}

async function init() {
    await fetchProductsFromSupabase();
    selectedParts = loadBuilder();
    renderBuilderSlots();
    updateTotal();
}

// ============ Catalog Logic ============
function formatSpecs(specs) {
    if (!specs || !Object.keys(specs).length) return '';
    const pairs = Object.entries(specs)
        .filter(([k, v]) => v) // Filter out empty values
        .map(([k, v]) => `${k}: ${v}`)
        .slice(0, 2); // Show max 2 specs
    return pairs.join(', ');
}

// ============ Compatibility Logic ============
function getCompatibleMotherboards() {
    const cpu = selectedParts['CPU'];
    if (!cpu || !cpu.specs || !cpu.specs.socket) return allProducts.filter(p => p.category === 'Motherboard');
    const cpuSocket = cpu.specs.socket;
    return allProducts.filter(p => p.category === 'Motherboard' && p.specs && p.specs.socket === cpuSocket);
}

function getCompatibleCPUs() {
    const mobo = selectedParts['Motherboard'];
    if (!mobo || !mobo.specs || !mobo.specs.socket) return allProducts.filter(p => p.category === 'CPU');
    const moboSocket = mobo.specs.socket;
    return allProducts.filter(p => p.category === 'CPU' && p.specs && p.specs.socket === moboSocket);
}

function getCompatibleRAM() {
    const mobo = selectedParts['Motherboard'];
    if (!mobo || !mobo.specs || !mobo.specs['supported-ram']) return allProducts.filter(p => p.category === 'RAM');
    const ramType = mobo.specs['supported-ram'];
    return allProducts.filter(p => p.category === 'RAM' && p.specs && p.specs['ram-type'] === ramType);
}

function calculatePowerEstimate() {
    let power = 50; // Base system power
    if (selectedParts['CPU'] && selectedParts['CPU'].specs) {
        // Extract cores number from format like "8-Core / 16-Thread"
        const coresStr = selectedParts['CPU'].specs.cores || '';
        const coresMatch = coresStr.match(/(\d+)/);
        const cores = coresMatch ? parseInt(coresMatch[1]) : 0;
        power += Math.max(65, cores * 5); // Rough TDP estimate
    }
    if (selectedParts['GPU'] && selectedParts['GPU'].specs) {
        const vram = selectedParts['GPU'].specs.vram ? parseInt(selectedParts['GPU'].specs.vram) : 0;
        power += Math.max(120, vram * 10); // Rough GPU power
    }
    return power;
}

function getCompatibilityStatus() {
    const status = { isCompatible: true, warnings: [] };
    const cpu = selectedParts['CPU'];
    const mobo = selectedParts['Motherboard'];
    const ram = selectedParts['RAM'];
    const cooler = selectedParts['CPU Cooler'];
    
    if (cpu && mobo && cpu.specs && mobo.specs) {
        if (cpu.specs.socket && mobo.specs.socket && cpu.specs.socket !== mobo.specs.socket) {
            status.isCompatible = false;
            status.warnings.push(`Socket Mismatch: ${cpu.specs.socket} vs ${mobo.specs.socket}`);
        }
    }
    
    if (mobo && ram && mobo.specs && ram.specs) {
        if (mobo.specs['supported-ram'] && ram.specs['ram-type'] && mobo.specs['supported-ram'] !== ram.specs['ram-type']) {
            status.isCompatible = false;
            status.warnings.push(`RAM Type Mismatch: ${mobo.specs['supported-ram']} vs ${ram.specs['ram-type']}`);
        }
    }
    
    if (cpu && cooler && cpu.specs && cooler.specs) {
        if (cpu.specs.socket && cooler.specs.socket && cpu.specs.socket !== cooler.specs.socket) {
            status.isCompatible = false;
            status.warnings.push(`Cooler Socket Mismatch: ${cpu.specs.socket} vs ${cooler.specs.socket}`);
        }
    }
    
    const psu = selectedParts['PSU'];
    const powerNeeded = calculatePowerEstimate();
    if (psu && psu.specs && psu.specs.wattage) {
        const psuWatts = parseInt(psu.specs.wattage) || 0;
        if (psuWatts < powerNeeded) {
            status.warnings.push(`⚠️ PSU: ${psuWatts}W may be insufficient for ${powerNeeded}W needed`);
        }
    }
    
    return status;
}

function filterProductsBySearch(products, searchTerm) {
    if (!searchTerm) return products;
    return products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
}

function sortProducts(products, sortOrder) {
    const sorted = [...products];
    if (sortOrder === 'price-asc') {
        sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
    } else if (sortOrder === 'price-desc') {
        sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
    }
    return sorted;
}

function filterCatalog(targetCat, searchTerm = '', sortOrder = '') {
    const grid = document.getElementById('product-grid');
    let filtered = targetCat === 'All' ? allProducts : allProducts.filter(p => p.category === targetCat);
    filtered = filterProductsBySearch(filtered, searchTerm);
    filtered = sortProducts(filtered, sortOrder);
    
    grid.innerHTML = filtered.map(p => `
        <div class="glass p-3 md:p-5 rounded-2xl flex flex-col group border border-white/5 relative animate-fade-in transition-all hover:neon-border">
            <button onclick="deleteProduct('${p.id}')" class="delete-btn bg-red-600/80 hover:bg-red-600 text-white px-2 py-1 rounded text-[9px] font-bold opacity-0 group-hover:opacity-100 transition">DELETE</button>
            <div class="bg-white/5 rounded-xl p-2 mb-3 h-32 md:h-40 flex items-center justify-center overflow-hidden">
                <img src="${p.image_url}" class="max-h-full object-contain group-hover:scale-110 transition duration-500">
            </div>
            <div class="text-[8px] text-cyan-400 font-bold uppercase mb-1 tracking-widest">${p.category}</div>
            <div class="text-[11px] md:text-sm text-white font-bold mb-2 h-8 line-clamp-2 leading-tight">${p.name}</div>
            <div class="text-[10px] text-gray-400 mb-3 line-clamp-2 h-8">${formatSpecs(p.specs)}</div>
            <div class="flex justify-between items-end mt-auto">
                <div class="text-sm md:text-lg text-green-400 font-bold font-gaming">${Number(p.price).toLocaleString()} <span class="text-[10px]">₭</span></div>
                <button onclick="openEditModal('${p.id}')" class="bg-cyan-600/20 hover:bg-cyan-600 text-cyan-400 hover:text-white px-3 py-1 rounded-lg border border-cyan-500/50 transition-all text-[9px] font-bold uppercase">
                    EDIT
                </button>
            </div>
        </div>`).join('');
}

// ============ Admin & Edit Logic ============
function openEditModal(productId) {
    const product = allProducts.find(p => p.id == productId);
    if (!product) return;

    document.getElementById('admin-modal').classList.remove('hidden');
    document.getElementById('admin-title').innerText = "EDIT PRODUCT";
    document.getElementById('btn-save').innerText = "UPDATE PRODUCT";

    document.getElementById('p-id').value = product.id;
    document.getElementById('p-name').value = product.name;
    document.getElementById('p-category').value = product.category;
    document.getElementById('p-price').value = product.price;

    renderDynamicSpecs();

    // Show existing image
    const previewImg = document.getElementById('preview-img');
    if (product.image_url && !product.image_url.includes('placeholder')) {
        previewImg.src = product.image_url;
        previewImg.classList.remove('hidden');
    }

    if (product.specs) {
        setTimeout(() => {
            Object.entries(product.specs).forEach(([key, val]) => {
                const el = document.getElementById('spec-' + key);
                if (el) el.value = val;
            });
        }, 50);
    }
}

function openAdminModal() {
    document.getElementById('p-id').value = "";
    document.getElementById('product-form').reset();
    document.getElementById('admin-title').innerText = "ADD NEW PRODUCT";
    document.getElementById('btn-save').innerText = "SAVE PRODUCT";
    document.getElementById('preview-img').classList.add('hidden');
    renderDynamicSpecs();
    document.getElementById('admin-modal').classList.remove('hidden');
}

async function deleteProduct(productId) {
    if (!confirm("ลบสินค้านี้ใช่หรือไม่?")) return;
    try {
        if (!supabaseClient) throw new Error('Supabase client not configured');
        const { error } = await supabaseClient.from('products').delete().eq('id', productId);
        if (error) throw error;
        await fetchProductsFromSupabase();
    } catch (err) {
        alert('ผิดพลาด: ' + (err.message || JSON.stringify(err)));
    }
}

// Image preview
document.getElementById('p-image-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const previewImg = document.getElementById('preview-img');
            previewImg.src = event.target.result;
            previewImg.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
});

// Form submission
document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn-save');
    const pId = document.getElementById('p-id').value;

    btn.disabled = true;
    btn.innerText = "Processing...";

    try {
        const specInputs = document.querySelectorAll('[id^="spec-"]');
        const specs = {};
        specInputs.forEach(input => {
            const key = input.id.replace('spec-', '');
            specs[key] = input.value;
        });

        const productData = {
            name: document.getElementById('p-name').value,
            category: document.getElementById('p-category').value,
            price: parseFloat(document.getElementById('p-price').value),
            specs: specs,
            image_url: "https://via.placeholder.com/150"
        };

        // Handle image
        const fileInput = document.getElementById('p-image-file');
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                productData.image_url = event.target.result; // Base64
                saveProductToStorage(pId, productData, btn);
            };
            reader.readAsDataURL(file);
        } else {
            // If editing and no new image, keep old image
            if (pId) {
                const oldProduct = allProducts.find(p => p.id === pId);
                if (oldProduct) {
                    productData.image_url = oldProduct.image_url;
                }
            }
            saveProductToStorage(pId, productData, btn);
        }
    } catch (err) {
        alert("ผิดพลาด: " + err.message);
        btn.disabled = false;
        btn.innerText = btn.innerText.replace("Processing...", "Save Changes");
    }
});

async function saveProductToStorage(pId, productData, btn) {
    try {
        if (!supabaseClient) throw new Error('Supabase client not configured');

        if (pId) {
            // Update existing row
            const { data, error } = await supabaseClient
                .from('products')
                .update({
                    name: productData.name,
                    category: productData.category,
                    price: productData.price,
                    image_url: productData.image_url,
                    specs: productData.specs
                })
                .eq('id', pId)
                .select()
                .single();
            if (error) throw error;
        } else {
            // Insert new row
            const insertObj = {
                name: productData.name,
                category: productData.category,
                price: productData.price,
                image_url: productData.image_url,
                specs: productData.specs
            };
            const { data, error } = await supabaseClient.from('products').insert([insertObj]).select().single();
            if (error) throw error;
        }

        alert("สำเร็จ!");
        closeAdminModal();
        await fetchProductsFromSupabase();
    } catch (err) {
        alert("ผิดพลาด: " + (err.message || JSON.stringify(err)));
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerText = "Save Changes";
        }
    }
}

// ============ Dynamic Specs ============
function renderDynamicSpecs() {
    const cat = document.getElementById('p-category').value;
    const container = document.getElementById('dynamic-specs-container');
    const inputStyle = "w-full bg-slate-800 border border-gray-700 p-3 rounded-lg text-white text-sm outline-none focus:border-cyan-400 transition";
    const labelStyle = "block text-[10px] text-gray-400 mb-1 uppercase font-bold";
    let html = "";
    
    switch(cat) {
        case 'CPU':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Socket</label>
                        <select id="spec-socket" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>LGA1700</option>
                            <option>LGA1200</option>
                            <option>AM5</option>
                            <option>AM4</option>
                        </select>
                    </div>
                    <div>
                        <label class="${labelStyle}">Generation</label>
                        <select id="spec-generation" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>Gen 10</option>
                            <option>Gen 11</option>
                            <option>Gen 12</option>
                            <option>Gen 13</option>
                            <option>Gen 14</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="${labelStyle}">Cores/Threads</label>
                        <input type="text" id="spec-cores" class="${inputStyle}" placeholder="e.g., 8-Core / 16-Thread">
                    </div>
                </div>`;
            break;
        case 'Motherboard':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Socket</label>
                        <input type="text" id="spec-socket" class="${inputStyle}" placeholder="e.g., LGA1700, AM5">
                    </div>
                    <div>
                        <label class="${labelStyle}">Supported RAM</label>
                        <select id="spec-supported-ram" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>DDR4</option>
                            <option>DDR5</option>
                        </select>
                    </div>
                </div>`;
            break;
        case 'GPU':
            html = `<div><label class="${labelStyle}">VRAM</label><input type="text" id="spec-vram" class="${inputStyle}" placeholder="e.g., 8GB GDDR6"></div>`;
            break;
        case 'RAM':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Capacity</label>
                        <input type="text" id="spec-capacity" class="${inputStyle}" placeholder="e.g., 16GB">
                    </div>
                    <div>
                        <label class="${labelStyle}">RAM Type</label>
                        <select id="spec-ram-type" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>DDR3</option>
                            <option>DDR4</option>
                            <option>DDR5</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="${labelStyle}">Bus Speed</label>
                        <input type="text" id="spec-bus-speed" class="${inputStyle}" placeholder="e.g., 3200 MHz">
                    </div>
                </div>`;
            break;
        case 'PSU':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Wattage</label>
                        <input type="text" id="spec-wattage" class="${inputStyle}" placeholder="e.g., 650W">
                    </div>
                    <div>
                        <label class="${labelStyle}">80 Plus Rating (optional)</label>
                        <select id="spec-80plus" class="${inputStyle}">
                            <option value="">Unspecified</option>
                            <option>80 Plus</option>
                            <option>80 Plus Bronze</option>
                            <option>80 Plus Silver</option>
                            <option>80 Plus Gold</option>
                            <option>80 Plus Platinum</option>
                            <option>80 Plus Titanium</option>
                        </select>
                    </div>
                </div>`;
            break;
        case 'Storage':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Type</label>
                        <select id="spec-storage-type" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>M.2 NVMe</option>
                            <option>SATA SSD</option>
                            <option>HDD</option>
                        </select>
                    </div>
                    <div>
                        <label class="${labelStyle}">Capacity</label>
                        <input type="text" id="spec-storage-capacity" class="${inputStyle}" placeholder="e.g., 1TB">
                    </div>
                </div>`;
            break;
        case 'CPU Cooler':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Cooler Type</label>
                        <select id="spec-cooler-type" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>Air</option>
                            <option>Liquid</option>
                        </select>
                    </div>
                    <div>
                        <label class="${labelStyle}">Socket Support</label>
                        <select id="spec-socket" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>LGA1700</option>
                            <option>LGA1200</option>
                            <option>AM5</option>
                            <option>AM4</option>
                        </select>
                    </div>
                </div>`;
            break;
        case 'Case Fan':
            html = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="${labelStyle}">Fan Size</label>
                        <select id="spec-fan-size" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>80mm</option>
                            <option>92mm</option>
                            <option>120mm</option>
                            <option>140mm</option>
                            <option>200mm</option>
                        </select>
                    </div>
                    <div>
                        <label class="${labelStyle}">Lighting</label>
                        <select id="spec-lighting" class="${inputStyle}">
                            <option value="">Select</option>
                            <option>RGB</option>
                            <option>ARGB</option>
                            <option>None</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="${labelStyle}">RPM & Airflow</label>
                        <input type="text" id="spec-rpm-airflow" class="${inputStyle}" placeholder="e.g., 1200 RPM, 85 CFM">
                    </div>
                </div>`;
            break;
        default:
            html = `<p class="text-[10px] text-gray-500 italic">No additional specs required.</p>`;
    }
    container.innerHTML = html;
}

function applySearchAndSort() {
    const searchInput = document.getElementById('catalog-search');
    const sortSelect = document.getElementById('catalog-sort');
    const currentSearch = searchInput ? searchInput.value : '';
    const currentSort = sortSelect ? sortSelect.value : '';
    filterCatalog('All', currentSearch, currentSort);
}

function renderCategoryButtons() {
    const container = document.getElementById('category-container');
    container.innerHTML = `<button onclick="resetCatalogFilters('All')" class="px-5 py-2 glass rounded-full text-[10px] font-bold uppercase shrink-0 hover:border-cyan-500 transition">All Items</button>` +
        categories.map(cat => `<button onclick="resetCatalogFilters('${cat}')" class="px-5 py-2 glass rounded-full text-[10px] font-bold uppercase shrink-0 hover:border-cyan-500 transition">${cat}</button>`).join('');
}

function resetCatalogFilters(cat) {
    const searchInput = document.getElementById('catalog-search');
    const sortSelect = document.getElementById('catalog-sort');
    if (searchInput) searchInput.value = '';
    if (sortSelect) sortSelect.value = '';
    filterCatalog(cat);
}

// ============ Builder Logic ============
function renderBuilderSlots() {
    const container = document.getElementById('builder-slots');
    container.innerHTML = categories.map(cat => {
        const item = selectedParts[cat];
        return `<div class="glass p-3 rounded-2xl flex justify-between items-center border-l-4 ${item ? 'border-cyan-400' : 'border-gray-700'} animate-fade-in">
            <div class="flex items-center gap-3">
                ${item ? `<img src="${item.image_url}" class="w-10 h-10 object-contain bg-white rounded p-1">` : `<div class="w-10 h-10 bg-slate-800 rounded flex items-center justify-center text-[10px] text-gray-600 font-gaming">?</div>`}
                <div>
                    <div class="text-[8px] text-cyan-500 font-bold uppercase">${cat}</div>
                    <div class="text-[10px] md:text-xs truncate max-w-[150px] ${item ? 'text-white font-bold' : 'text-gray-600 italic'}">${item ? item.name : 'Select part...'}</div>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="openPicker('${cat}')" class="bg-slate-800 hover:bg-cyan-600 px-4 py-2 rounded-xl text-[9px] font-bold uppercase transition border border-white/5">${item ? 'Change' : 'Add'}</button>
                ${item ? `<button onclick="removeItem('${cat}')" class="bg-red-900/30 hover:bg-red-700 text-red-400 px-3 py-2 rounded-xl text-[9px] font-bold uppercase transition border border-red-500/50">✕</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

function openPicker(cat) {
    const modal = document.getElementById('modal');
    const modalDiv = modal.querySelector('div');
    document.getElementById('modal-title').innerText = `Select ${cat}`;
    
    // Remove old search div if exists
    const oldSearch = modalDiv.querySelector('[data-search-div]');
    if (oldSearch) oldSearch.remove();
    
    // Add search and sort header
    const searchDiv = document.createElement('div');
    searchDiv.setAttribute('data-search-div', '1');
    searchDiv.className = 'p-4 flex gap-2 border-b border-gray-700 sticky top-12 z-10 bg-slate-900';
    searchDiv.innerHTML = `
        <input type="text" id="picker-search" placeholder="Search..." class="flex-1 bg-slate-800 border border-gray-700 p-2 rounded-lg text-white text-xs outline-none focus:border-cyan-400" oninput="updatePickerList('${cat}')">
        <select id="picker-sort" onchange="updatePickerList('${cat}')" class="bg-slate-800 border border-gray-700 p-2 rounded-lg text-white text-xs outline-none focus:border-cyan-400">
            <option value="">Sort</option>
            <option value="price-asc">Price Low</option>
            <option value="price-desc">Price High</option>
        </select>
    `;
    
    const modalList = document.getElementById('modal-list');
    modalList.parentElement.insertBefore(searchDiv, modalList);
    
    updatePickerList(cat);
    modal.classList.remove('hidden');
}

function updatePickerList(cat) {
    const list = document.getElementById('modal-list');
    const searchInput = document.getElementById('picker-search');
    const sortSelect = document.getElementById('picker-sort');
    const searchTerm = searchInput ? searchInput.value : '';
    const sortOrder = sortSelect ? sortSelect.value : '';
    
    let filtered = allProducts.filter(p => p.category === cat);
    
    // Apply compatibility filtering
    if (cat === 'CPU') {
        const mobo = selectedParts['Motherboard'];
        if (mobo && mobo.specs && mobo.specs.socket) {
            filtered = filtered.filter(p => p.specs && p.specs.socket === mobo.specs.socket);
        }
    } else if (cat === 'Motherboard') {
        const cpu = selectedParts['CPU'];
        if (cpu && cpu.specs && cpu.specs.socket) {
            filtered = filtered.filter(p => p.specs && p.specs.socket === cpu.specs.socket);
        }
    } else if (cat === 'RAM') {
        const mobo = selectedParts['Motherboard'];
        if (mobo && mobo.specs && mobo.specs['supported-ram']) {
            filtered = filtered.filter(p => p.specs && p.specs['ram-type'] === mobo.specs['supported-ram']);
        }
    } else if (cat === 'CPU Cooler') {
        const cpu = selectedParts['CPU'];
        if (cpu && cpu.specs && cpu.specs.socket) {
            filtered = filtered.filter(p => p.specs && p.specs.socket === cpu.specs.socket);
        }
    }
    
    filtered = filterProductsBySearch(filtered, searchTerm);
    filtered = sortProducts(filtered, sortOrder);
    
    if (filtered.length === 0) {
        list.innerHTML = `<div class="col-span-2 text-center text-gray-400 py-8">ยังไม่มีสินค้าในหมวด ${cat}</div>`;
    } else {
        list.innerHTML = filtered.map(p => `<div class="glass rounded-xl p-3 flex gap-3 items-center border border-white/5 hover:border-cyan-500/50 transition"><img src="${p.image_url}" class="w-14 h-14 object-contain rounded bg-white p-1"><div class="flex-1 overflow-hidden"><div class="font-bold text-xs text-white truncate">${p.name}</div><div class="text-[9px] text-gray-400 line-clamp-1">${formatSpecs(p.specs)}</div><div class="text-green-400 font-bold text-xs mt-1">${Number(p.price).toLocaleString()} ₭</div></div><button onclick="confirmSelection('${cat}', '${p.id}')" class="bg-cyan-600 px-3 py-2 rounded-lg text-[10px] font-bold uppercase hover:bg-cyan-500 transition shadow-lg">Select</button></div>`).join('');
    }
}

function confirmSelection(cat, id) {
    selectedParts[cat] = allProducts.find(p => p.id == id);
    saveBuilder();
    renderBuilderSlots();
    updateTotal();
    closeModal();
}

function removeItem(category) {
    if (!confirm(`Remove ${category} from build?`)) return;
    delete selectedParts[category];
    saveBuilder();
    renderBuilderSlots();
    updateTotal();
}

function updateTotal() {
    let total = 0;
    const container = document.getElementById('summary-items');
    const summaryBox = document.getElementById('summary-box');
    
    container.innerHTML = Object.entries(selectedParts).map(([cat, p]) => {
        total += Number(p.price);
        return `<div class="flex justify-between items-center bg-white/5 p-2 rounded"><span>${cat}</span><span class="text-cyan-400 font-gaming">${Number(p.price).toLocaleString()} ₭</span></div>`;
    }).join('');
    document.getElementById('total-price-display').innerText = total.toLocaleString();
    
    // Calculate power estimate and compatibility
    const powerEstimate = calculatePowerEstimate();
    const compatibility = getCompatibilityStatus();
    
    // Remove old badges and power div
    summaryBox.querySelectorAll('[data-compat-badge], [data-power-div]').forEach(el => el.remove());
    
    // Add compatibility badge
    const badge = document.createElement('div');
    badge.setAttribute('data-compat-badge', '1');
    badge.className = compatibility.isCompatible ? 'text-[10px] text-green-400 mb-3' : 'text-[10px] text-orange-400 mb-3';
    badge.innerHTML = compatibility.isCompatible ? '✅ All Compatible' : '⚠️ Check Compatibility';
    container.parentElement.insertBefore(badge, container);
    
    // Add power estimate
    const powerDiv = document.createElement('div');
    powerDiv.setAttribute('data-power-div', '1');
    powerDiv.className = 'text-[10px] text-gray-400 mt-2 p-2 bg-slate-800/50 rounded';
    powerDiv.innerHTML = `⚡ Est. Power: ${powerEstimate}W`;
    container.parentElement.appendChild(powerDiv);
    
    // Add PSU warning if needed
    if (!compatibility.isCompatible && compatibility.warnings.some(w => w.includes('PSU'))) {
        const warning = document.createElement('div');
        warning.className = 'text-[9px] text-red-400 mt-2 p-2 bg-red-900/20 rounded';
        warning.innerHTML = compatibility.warnings.filter(w => w.includes('PSU')).join('<br>');
        container.parentElement.appendChild(warning);
    }
}

// ============ Tab Switching ============
function switchTab(tab) {
    document.getElementById('section-catalog').classList.toggle('hidden', tab !== 'catalog');
    document.getElementById('section-builder').classList.toggle('hidden', tab !== 'builder');
    document.getElementById('tab-catalog').className = tab === 'catalog' ? 'tab-active py-1 text-[10px] md:text-sm font-gaming uppercase transition' : 'py-1 text-[10px] md:text-sm font-gaming uppercase text-gray-400 transition';
    document.getElementById('tab-builder').className = tab === 'builder' ? 'tab-active py-1 text-[10px] md:text-sm font-gaming uppercase transition' : 'py-1 text-[10px] md:text-sm font-gaming uppercase text-gray-400 transition';
}

// ============ Modals ============
function closeAdminModal() {
    document.getElementById('admin-modal').classList.add('hidden');
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

// Initialize on load
init();
</script>

<script>
// Save only the summary box as PNG using html2canvas
async function saveImage() {
    const el = document.getElementById('summary-box');
    if (!el) {
        alert('Summary box not found');
        return;
    }
    try {
        const canvas = await html2canvas(el, { scale: 2, backgroundColor: null });
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'TIANTIAN-BUILD.png';
        document.body.appendChild(link);
        link.click();
        link.remove();
    } catch (err) {
        alert('Error saving image: ' + (err.message || err));
    }
}

function resetBuild() {
    if (!confirm('Reset build and clear selections?')) return;
    selectedParts = {};
    try { localStorage.removeItem(BUILDER_KEY); } catch (e) {}
    renderBuilderSlots();
    updateTotal();
}
</script>
